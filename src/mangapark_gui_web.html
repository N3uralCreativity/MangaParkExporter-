<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Site Manga Exporter v2.0</title>
    <style>
        :root {
            --base-font-size: 16px;
            --animation-speed: 1;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--base-font-size);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            transition: all calc(0.3s * var(--animation-speed)) ease;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            font-size: 48px;
            margin-bottom: 10px;
            animation: float calc(3s * var(--animation-speed)) ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .logo-text {
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 0;
            height: 100%;
            background: rgba(102, 126, 234, 0.1);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item:hover {
            color: #f1f5f9;
            background: #334155;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: scale(1.02);
        }

        .nav-item.active:hover {
            transform: scale(1.05) translateX(5px);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.2) rotate(5deg);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            scroll-behavior: smooth;
        }

        .main-content::-webkit-scrollbar {
            width: 10px;
        }

        .main-content::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 5px;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
        }

        .breadcrumb .active {
            color: #667eea;
            font-weight: 600;
        }

        /* Stats Badges */
        .stats {
            display: flex;
            gap: 15px;
        }

        .stat-badge {
            background: #1e293b;
            border: 2px solid;
            border-radius: 8px;
            padding: 10px 20px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .stat-badge:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all calc(0.4s * var(--animation-speed)) cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp calc(0.6s * var(--animation-speed)) ease-out backwards;
            border: 1px solid var(--border-color);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover {
            box-shadow: 0 10px 40px var(--shadow);
            transform: translateY(-5px);
        }

        .card-title {
            font-size: calc(var(--base-font-size) * 1.375);
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            color: var(--text-primary);
            align-items: center;
            gap: 10px;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: calc(var(--base-font-size) * 0.8125);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Site Cards Grid */
        .site-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .site-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all calc(0.4s * var(--animation-speed)) cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .site-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .site-card:hover::before {
            opacity: 1;
        }

        .site-card:hover {
            border-color: #667eea;
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.4);
        }

        .site-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5);
            }
            50% {
                transform: scale(1.03);
                box-shadow: 0 15px 60px rgba(102, 126, 234, 0.7);
            }
        }

        .site-icon {
            font-size: 42px;
            margin-bottom: 15px;
            display: inline-block;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .site-card:hover .site-icon {
            transform: scale(1.3) rotate(10deg);
        }

        .site-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .site-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 8px;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .status-planned {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        /* Buttons */
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-secondary {
            background: #334155;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        /* Progress */
        .progress-section {
            margin: 30px 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: #334155;
            z-index: 0;
        }

        .progress-line {
            position: absolute;
            top: 30px;
            left: 60px;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 24px;
            border: 3px solid #334155;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            animation: stepActive 0.8s ease-out;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
        }

        @keyframes stepActive {
            0% {
                transform: scale(0.8) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .step.done .step-circle {
            background: #10b981;
            border-color: #10b981;
            animation: stepDone 0.5s ease-out;
        }

        @keyframes stepDone {
            0%, 50% {
                transform: scale(1);
            }
            25% {
                transform: scale(1.2);
            }
        }

        .step-label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .step.done .step-label {
            color: #10b981;
        }

        .progress-bar-container {
            background: #334155;
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-label {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        /* Log Section */
        .log-container {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.8;
        }

        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .log-entry {
            margin: 5px 0;
            opacity: 0;
            animation: logFadeIn 0.4s ease-out forwards;
        }

        @keyframes logFadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-time {
            color: #94a3b8;
            margin-right: 10px;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #667eea;
        }

        .log-warning {
            color: #f59e0b;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Animations for staggered appearance */
        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .mode-card {
            flex: 1;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mode-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .mode-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5);
        }

        .mode-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .mode-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .mode-desc {
            font-size: 11px;
            color: #94a3b8;
        }

        .mode-card.active .mode-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Input Fields */
        .input-group {
            margin: 15px 0;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #f1f5f9;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-field::placeholder {
            color: #475569;
        }

        /* Custom Select Dropdown */
        .custom-select {
            position: relative;
            width: 100%;
        }

        .select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-trigger:hover {
            border-color: #475569;
        }

        .custom-select.open .select-trigger {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .select-value {
            color: #f1f5f9;
            font-size: 14px;
        }

        .select-arrow {
            color: #94a3b8;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .custom-select.open .select-arrow {
            transform: rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .custom-select.open .select-options {
            max-height: 300px;
            opacity: 1;
            transform: translateY(0);
            overflow-y: auto;
        }

        .select-option {
            padding: 12px 16px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #334155;
        }

        .select-option:last-child {
            border-bottom: none;
        }

        .select-option:hover {
            background: #334155;
            color: #fff;
        }

        .select-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: 600;
        }

        .select-option.selected:hover {
            background: linear-gradient(135deg, #7c8eef 0%, #8659b0 100%);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">üåê</div>
                <div class="logo-text">Manga Exporter</div>
                <div class="logo-subtitle">v2.0 - Multi-Site</div>
            </div>

            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchView('dashboard')">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="switchView('export')">
                    <span class="nav-icon">üì§</span>
                    <span>Export</span>
                </div>
                    <!-- <div class="nav-item" onclick="switchView('history')">
                        <span class="nav-icon">üìù</span>
                        <span>History</span>
                    </div> -->
                <div class="nav-item" onclick="switchView('settings')">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
                <div class="nav-item" onclick="switchView('help')">
                    <span class="nav-icon">‚ùì</span>
                    <span>Help</span>
                </div>
            </nav>

            <div style="text-align: center; color: #475569; font-size: 11px;">
                <div>Made with ‚ù§Ô∏è</div>
                <div>v2.0.0</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <script>
        let currentView = 'dashboard';
        let currentSite = 'mangapark';
        let currentMode = 'authenticated';
        let isExporting = false;
        let progress = 0;
        let currentStep = 0;

        // Settings object to store all settings
        let appSettings = {
            theme: 'dark',
            animationSpeed: 'normal',
            fontSize: 'medium',
            desktopNotifications: false,
            soundEffects: false,
            errorNotifications: true,
            exportFormat: 'MAL XML + HTML',
            outputDirectory: './output',
            autoOpenHTML: false,
            includeUnmatched: true,
            requestTimeout: 30,
            maxRetries: 3,
            rateLimit: 2,
            useProxy: false
        };

        // Historique des exports
        let exportHistory = [];
        // Charger l'historique depuis le stockage local au d√©marrage
        try {
            exportHistory = JSON.parse(localStorage.getItem('exportHistory') || '[]');
        } catch (e) {
            exportHistory = [];
        }

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('appSettings');
            if (saved) {
                appSettings = { ...appSettings, ...JSON.parse(saved) };
            }
        }

        // Custom select dropdown functionality
        function initCustomSelect(selectId, currentValue, onChangeCallback) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const trigger = select.querySelector('.select-trigger');
            const valueSpan = select.querySelector('.select-value');
            const optionsContainer = select.querySelector('.select-options');
            const options = select.querySelectorAll('.select-option');
            
            // Set initial value
            options.forEach(opt => {
                if (opt.dataset.value === currentValue) {
                    valueSpan.textContent = opt.textContent;
                    opt.classList.add('selected');
                }
            });
            
            // Toggle dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = select.classList.contains('open');
                
                // Close all other dropdowns
                document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
                
                if (!isOpen) {
                    select.classList.add('open');
                }
            });
            
            // Handle option selection
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const value = option.dataset.value;
                    
                    // Update UI
                    options.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    valueSpan.textContent = option.textContent;
                    
                    // Close dropdown
                    select.classList.remove('open');
                    
                    // Call callback
                    if (onChangeCallback) {
                        onChangeCallback(value);
                    }
                });
            });
            
            // Close on outside click
            document.addEventListener('click', () => {
                select.classList.remove('open');
            });
        }

        // Save settings to localStorage
        function saveSettings(showNotification = false) {
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            if (showNotification) {
                showToast('Settings saved successfully', 'success');
            }
        }

        // Toggle setting helper
        function toggleSetting(settingName, checkboxId, evt) {
            // Prevent double-triggering from label click
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }
            
            const checkbox = document.getElementById(checkboxId);
            const newValue = !checkbox.checked;
            
            // Update checkbox immediately
            checkbox.checked = newValue;
            
            // Update settings
            appSettings[settingName] = newValue;
            saveSettings();
            
            // Force visual update by triggering CSS transition
            const label = checkbox.parentElement;
            if (label && label.classList.contains('toggle')) {
                label.classList.add('toggle-active');
                setTimeout(() => label.classList.remove('toggle-active'), 300);
            }
        }

        // Apply theme with full CSS variable support
        function applyTheme(theme, showNotification = false) {
            appSettings.theme = theme;
            const root = document.documentElement;
            
            // Apply visual theme changes
            if (theme === 'light') {
                // Light theme colors
                root.style.setProperty('--bg-primary', '#f1f5f9');
                root.style.setProperty('--bg-secondary', '#ffffff');
                root.style.setProperty('--bg-card', '#ffffff');
                root.style.setProperty('--text-primary', '#1e293b');
                root.style.setProperty('--text-secondary', '#64748b');
                root.style.setProperty('--border-color', '#e2e8f0');
                root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.1)');
                
                document.body.style.background = '#f1f5f9';
                document.body.style.color = '#1e293b';
                
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (sidebar) {
                    sidebar.style.background = '#ffffff';
                    sidebar.style.color = '#1e293b';
                    sidebar.style.borderRight = '1px solid #e2e8f0';
                }
                
                if (mainContent) {
                    mainContent.style.background = '#f8fafc';
                }
                
                // Update all cards
                document.querySelectorAll('.card').forEach(card => {
                    card.style.background = '#ffffff';
                    card.style.color = '#1e293b';
                    card.style.borderColor = '#e2e8f0';
                    card.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                });
                
                // Update card titles
                document.querySelectorAll('.card-title').forEach(title => {
                    title.style.color = '#1e293b';
                });
                
                // Update card subtitles
                document.querySelectorAll('.card-subtitle').forEach(subtitle => {
                    subtitle.style.color = '#64748b';
                });
                
                // Update site cards
                document.querySelectorAll('.site-card').forEach(card => {
                    card.style.background = '#ffffff';
                    card.style.color = '#1e293b';
                    card.style.borderColor = '#e2e8f0';
                });
                
                // Update mode cards
                document.querySelectorAll('.mode-card').forEach(card => {
                    if (!card.classList.contains('active')) {
                        card.style.background = '#ffffff';
                        card.style.color = '#1e293b';
                        card.style.borderColor = '#e2e8f0';
                    }
                });
                
                // Update nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (!item.classList.contains('active')) {
                        item.style.color = '#64748b';
                    }
                });
                
                // Update input fields
                document.querySelectorAll('.input-field').forEach(input => {
                    input.style.background = '#ffffff';
                    input.style.color = '#1e293b';
                    input.style.borderColor = '#e2e8f0';
                });
                
                // Update input labels
                document.querySelectorAll('.input-label').forEach(label => {
                    label.style.color = '#64748b';
                });
                
                // Update custom selects
                document.querySelectorAll('.select-trigger').forEach(trigger => {
                    trigger.style.background = '#ffffff';
                    trigger.style.borderColor = '#e2e8f0';
                });
                
                document.querySelectorAll('.select-value').forEach(val => {
                    val.style.color = '#1e293b';
                });
                
                document.querySelectorAll('.select-arrow').forEach(arrow => {
                    arrow.style.color = '#64748b';
                });
                
                document.querySelectorAll('.select-options').forEach(opts => {
                    opts.style.background = '#ffffff';
                    opts.style.borderColor = '#e2e8f0';
                });
                
                document.querySelectorAll('.select-option').forEach(opt => {
                    if (!opt.classList.contains('selected')) {
                        opt.style.color = '#1e293b';
                        opt.style.borderColor = '#e2e8f0';
                    }
                });
                
                // Update buttons
                document.querySelectorAll('.btn-secondary').forEach(btn => {
                    btn.style.background = '#e2e8f0';
                    btn.style.color = '#1e293b';
                });
                
                // Update log container
                document.querySelectorAll('.log-container').forEach(log => {
                    log.style.background = '#f8fafc';
                    log.style.color = '#1e293b';
                    log.style.borderColor = '#e2e8f0';
                });
                
                // Update progress elements
                document.querySelectorAll('.progress-bar-container').forEach(bar => {
                    bar.style.background = '#e2e8f0';
                });
                
                // Update breadcrumb
                document.querySelectorAll('.breadcrumb').forEach(breadcrumb => {
                    breadcrumb.style.color = '#64748b';
                });
                
                // Update progress steps
                document.querySelectorAll('.step-circle').forEach(circle => {
                    if (!circle.parentElement.classList.contains('active') && !circle.parentElement.classList.contains('done')) {
                        circle.style.background = '#e2e8f0';
                        circle.style.borderColor = '#e2e8f0';
                    }
                });
                
                document.querySelectorAll('.step-label').forEach(label => {
                    label.style.color = '#64748b';
                });
                
                // Update progress steps line
                const progressLinesBefore = document.querySelectorAll('.progress-steps::before');
                document.querySelectorAll('.progress-steps').forEach(steps => {
                    const style = document.createElement('style');
                    style.textContent = '.progress-steps::before { background: #e2e8f0 !important; }';
                    if (!document.querySelector('style[data-progress-light]')) {
                        style.setAttribute('data-progress-light', 'true');
                        document.head.appendChild(style);
                    }
                });
                
                // Update nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.style.transition = 'all 0.3s ease';
                });
                
                // Update toast notifications
                document.querySelectorAll('.toast').forEach(toast => {
                    toast.style.background = '#ffffff';
                    toast.style.color = '#1e293b';
                    toast.style.boxShadow = '0 10px 40px rgba(0, 0, 0, 0.15)';
                });
                
                // Update stats/counters
                document.querySelectorAll('.stat-number').forEach(stat => {
                    stat.style.color = '#1e293b';
                });
                
                if (showNotification) showToast('Light theme applied', 'success');
            } else if (theme === 'dark') {
                // Dark theme colors
                root.style.setProperty('--bg-primary', '#0f172a');
                root.style.setProperty('--bg-secondary', '#1e293b');
                root.style.setProperty('--bg-card', '#1e293b');
                root.style.setProperty('--text-primary', '#e2e8f0');
                root.style.setProperty('--text-secondary', '#94a3b8');
                root.style.setProperty('--border-color', '#334155');
                root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.3)');
                
                document.body.style.background = '#0f172a';
                document.body.style.color = '#e2e8f0';
                
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (sidebar) {
                    sidebar.style.background = '#1e293b';
                    sidebar.style.color = '#e2e8f0';
                    sidebar.style.borderRight = '1px solid #334155';
                }
                
                if (mainContent) {
                    mainContent.style.background = '#0f172a';
                }
                
                // Update all cards
                document.querySelectorAll('.card').forEach(card => {
                    card.style.background = '#1e293b';
                    card.style.color = '#e2e8f0';
                    card.style.borderColor = '#334155';
                    card.style.boxShadow = 'none';
                });
                
                // Update card titles
                document.querySelectorAll('.card-title').forEach(title => {
                    title.style.color = '#e2e8f0';
                });
                
                // Update card subtitles
                document.querySelectorAll('.card-subtitle').forEach(subtitle => {
                    subtitle.style.color = '#94a3b8';
                });
                
                // Update site cards
                document.querySelectorAll('.site-card').forEach(card => {
                    card.style.background = '#1e293b';
                    card.style.color = '#e2e8f0';
                    card.style.borderColor = '#334155';
                });
                
                // Update mode cards
                document.querySelectorAll('.mode-card').forEach(card => {
                    if (!card.classList.contains('active')) {
                        card.style.background = '#1e293b';
                        card.style.color = '#e2e8f0';
                        card.style.borderColor = '#334155';
                    }
                });
                
                // Update nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (!item.classList.contains('active')) {
                        item.style.color = '#94a3b8';
                    }
                });
                
                // Update input fields
                document.querySelectorAll('.input-field').forEach(input => {
                    input.style.background = '#0f172a';
                    input.style.color = '#f1f5f9';
                    input.style.borderColor = '#334155';
                });
                
                // Update input labels
                document.querySelectorAll('.input-label').forEach(label => {
                    label.style.color = '#94a3b8';
                });
                
                // Update custom selects
                document.querySelectorAll('.select-trigger').forEach(trigger => {
                    trigger.style.background = '#0f172a';
                    trigger.style.borderColor = '#334155';
                });
                
                document.querySelectorAll('.select-value').forEach(val => {
                    val.style.color = '#f1f5f9';
                });
                
                document.querySelectorAll('.select-arrow').forEach(arrow => {
                    arrow.style.color = '#94a3b8';
                });
                
                document.querySelectorAll('.select-options').forEach(opts => {
                    opts.style.background = '#1e293b';
                    opts.style.borderColor = '#334155';
                });
                
                document.querySelectorAll('.select-option').forEach(opt => {
                    if (!opt.classList.contains('selected')) {
                        opt.style.color = '#e2e8f0';
                        opt.style.borderColor = '#334155';
                    }
                });
                
                // Update buttons
                document.querySelectorAll('.btn-secondary').forEach(btn => {
                    btn.style.background = '#334155';
                    btn.style.color = 'white';
                });
                
                // Update log container
                document.querySelectorAll('.log-container').forEach(log => {
                    log.style.background = '#0f172a';
                    log.style.color = '#e2e8f0';
                    log.style.borderColor = '#334155';
                });
                
                // Update progress elements
                document.querySelectorAll('.progress-bar-container').forEach(bar => {
                    bar.style.background = '#334155';
                });
                
                // Update breadcrumb
                document.querySelectorAll('.breadcrumb').forEach(breadcrumb => {
                    breadcrumb.style.color = '#94a3b8';
                });
                
                // Update progress steps
                document.querySelectorAll('.step-circle').forEach(circle => {
                    if (!circle.parentElement.classList.contains('active') && !circle.parentElement.classList.contains('done')) {
                        circle.style.background = '#334155';
                        circle.style.borderColor = '#334155';
                    }
                });
                
                document.querySelectorAll('.step-label').forEach(label => {
                    label.style.color = '#94a3b8';
                });
                
                // Update progress steps line
                const progressStyleDark = document.querySelector('style[data-progress-light]');
                if (progressStyleDark) {
                    progressStyleDark.remove();
                }
                
                // Update nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.style.transition = 'all 0.3s ease';
                });
                
                // Update toast notifications
                document.querySelectorAll('.toast').forEach(toast => {
                    toast.style.background = '#1e293b';
                    toast.style.color = '#e2e8f0';
                    toast.style.boxShadow = '0 10px 40px rgba(0, 0, 0, 0.3)';
                });
                
                // Update stats/counters
                document.querySelectorAll('.stat-number').forEach(stat => {
                    stat.style.color = '#e2e8f0';
                });
                
                if (showNotification) showToast('Dark theme applied', 'success');
            } else {
                // Auto - detect system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light', showNotification);
                return;
            }
            
            saveSettings();
        }

        // Apply animation speed
        function applyAnimationSpeed(speed, showNotification = false) {
            const root = document.documentElement;
            // For transitions: calc(time * speed) ‚Üí Slow=2 makes it longer, Fast=0.5 makes it shorter
            // For animations: calc(time / speed) ‚Üí Slow=0.5 makes it longer (3/0.5=6), Fast=2 makes it shorter (3/2=1.5)
            // BUT we use multiplication everywhere, so: Slow=2 (slower), Fast=0.5 (faster)
            const speeds = { slow: '2', normal: '1', fast: '0.5', none: '0.001' };
            const multiplier = speeds[speed] || '1';
            root.style.setProperty('--animation-speed', multiplier);
            
            // For 'none', also disable animations completely
            if (speed === 'none') {
                root.style.setProperty('--animation-speed', '0.001');
                // Optionally disable all animations
                document.body.style.animation = 'none';
            } else {
                document.body.style.animation = '';
            }
            
            appSettings.animationSpeed = speed;
            saveSettings(showNotification);
            if (showNotification) {
                showToast('Animation speed updated', 'success');
            }
        }

        // Apply font size
        function applyFontSize(size, showNotification = false) {
            const root = document.documentElement;
            const sizes = { small: '14px', medium: '16px', large: '18px' };
            root.style.setProperty('--base-font-size', sizes[size] || '16px');
            appSettings.fontSize = size;
            saveSettings(showNotification);
            if (showNotification) {
                showToast('Font size updated', 'success');
            }
        }

        // Clear cache
        function clearCache() {
            if (confirm('Are you sure you want to clear the cache?')) {
                localStorage.removeItem('exportHistory');
                showToast('Cache cleared successfully', 'success');
            }
        }

        // Clear export history
        function clearHistory() {
            if (confirm('Are you sure you want to clear export history?')) {
                exportHistory = [];
                localStorage.removeItem('exportHistory');
                showToast('History cleared successfully', 'success');
                showHistory();
            }
        }

        // Export settings
        function exportSettings() {
            const dataStr = JSON.stringify(appSettings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'manga-exporter-settings.json';
            link.click();
            URL.revokeObjectURL(url);
            showToast('Settings exported successfully', 'success');
        }

        // Reset all settings
        function resetAllSettings() {
            if (confirm('Are you sure you want to reset ALL settings to defaults? This cannot be undone!')) {
                localStorage.clear();
                appSettings = {
                    theme: 'dark',
                    animationSpeed: 'normal',
                    fontSize: 'medium',
                    desktopNotifications: false,
                    soundEffects: false,
                    errorNotifications: true,
                    exportFormat: 'MAL XML + HTML',
                    outputDirectory: './output',
                    autoOpenHTML: false,
                    includeUnmatched: true,
                    requestTimeout: 30,
                    maxRetries: 3,
                    rateLimit: 2,
                    useProxy: false
                };
                saveSettings();
                showToast('All settings reset to defaults', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // Initialize - call immediately and on DOMContentLoaded
        function initApp() {
            loadSettings();
            // Apply all settings on startup
            applyTheme(appSettings.theme, false);
            applyFontSize(appSettings.fontSize, false);
            applyAnimationSpeed(appSettings.animationSpeed, false);
            switchView('dashboard');
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Also call after a short delay as backup for embedded webviews
        setTimeout(initApp, 100);
        function switchView(view) {
            currentView = view;

            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the nav item (handle both click events and direct calls)
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                event.target.closest('.nav-item')?.classList.add('active');
            } else {
                // Direct call - find nav item by view name
                const navItem = document.querySelector(`.nav-item[onclick*="${view}"]`);
                if (navItem) navItem.classList.add('active');
            }

            const content = document.getElementById('mainContent');
            if (!content) return;
            
            // Fade out animation
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px)';

            setTimeout(() => {
                // Load content
                if (view === 'dashboard') showDashboard();
                else if (view === 'export') showExport();
                else if (view === 'history') showHistory();
                else if (view === 'settings') showSettings();
                else if (view === 'help') showHelp();

                // Re-apply theme after view change (without notification)
                applyTheme(appSettings.theme, false);

                // Fade in animation
                content.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => {
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 50);
            }, 300);
        }

        // Dashboard
        function showDashboard() {
            document.getElementById('mainContent').innerHTML = `
                <div class="header">
                    <div class="breadcrumb">
                        <span>Dashboard</span>
                        <span>‚Ä∫</span>
                        <span class="active">Overview</span>
                    </div>
                    <div class="stats">
                        <div class="stat-badge" style="border-color: #10b981;">
                            <div class="stat-value" style="color: #10b981;">0</div>
                            <div class="stat-label">Exported</div>
                        </div>
                        <div class="stat-badge" style="border-color: #ef4444;">
                            <div class="stat-value" style="color: #ef4444;">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        üëã Welcome to Multi-Site Manga Exporter
                    </div>
                    <div class="card-subtitle">
                        Export your manga collections from multiple sites to MyAnimeList with automatic MAL ID enrichment
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px;">üöÄ Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="site-card" onclick="switchView('export')">
                            <div class="site-icon">üì§</div>
                            <div class="site-name">Start New Export</div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Begin exporting</div>
                        </div>
                        <!-- <div class="site-card" onclick="switchView('history')">
                            <div class="site-icon">üìä</div>
                            <div class="site-name">View History</div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Past operations</div>
                        </div> -->
                        <div class="site-card" onclick="switchView('settings')">
                            <div class="site-icon">‚öôÔ∏è</div>
                            <div class="site-name">Settings</div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Configure app</div>
                        </div>
                        <div class="site-card" onclick="switchView('help')">
                            <div class="site-icon">‚ùì</div>
                            <div class="site-name">Get Help</div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Learn how to use</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Export View
        function showExport() {
            document.getElementById('mainContent').innerHTML = `
                <div class="header">
                    <div class="breadcrumb">
                        <span>Export</span>
                        <span>‚Ä∫</span>
                        <span class="active">MangaPark</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üåê Select Source Site</div>
                    <div class="site-grid">
                        <div class="site-card active" onclick="selectSite('mangapark')">
                            <div class="site-icon">üìö</div>
                            <div class="site-name">MangaPark</div>
                            <div class="site-status status-active">Active</div>
                        </div>
                        <!--
                        <div class="site-card">
                            <div class="site-icon">üìñ</div>
                            <div class="site-name">MangaDex</div>
                            <div class="site-status status-planned">Coming Soon</div>
                        </div>
                        <div class="site-card">
                            <div class="site-icon">üëÅÔ∏è</div>
                            <div class="site-name">MangaSee</div>
                            <div class="site-status status-planned">Coming Soon</div>
                        </div>
                        <div class="site-card">
                            <div class="site-icon">üåü</div>
                            <div class="site-name">AniList</div>
                            <div class="site-status status-planned">Coming Soon</div>
                        </div>
                        -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üîí Authentication Mode</div>
                    <div class="mode-toggle">
                        <div class="mode-card active" onclick="selectMode('authenticated', event)">
                            <div class="mode-icon">üîí</div>
                            <div class="mode-title">Authenticated</div>
                            <div class="mode-desc">Export your personal follows list</div>
                        </div>
                        <div class="mode-card" onclick="selectMode('public', event)">
                            <div class="mode-icon">üåê</div>
                            <div class="mode-title">Public</div>
                            <div class="mode-desc">Export any user's public list</div>
                        </div>
                    </div>
                </div>

                <div class="card" id="configSection">
                    <div class="card-title">‚öôÔ∏è Configuration</div>
                    <div class="input-group">
                        <label class="input-label">üç™ skey Cookie</label>
                        <input type="text" class="input-field" id="skeyCookie" placeholder="Enter skey value..." />
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Main authentication key</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">üîë tfv Cookie</label>
                        <input type="text" class="input-field" id="tfvCookie" placeholder="Enter tfv value..." />
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Token fingerprint verification</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">üé® theme Cookie</label>
                        <input type="text" class="input-field" id="themeCookie" placeholder="Enter theme value..." />
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Theme preference</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">üì± wd Cookie</label>
                        <input type="text" class="input-field" id="wdCookie" placeholder="Enter wd value..." />
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">Window/device identifier</div>
                    </div>
                    <button class="btn btn-secondary" onclick="showTutorial()" style="margin-top: 10px;">
                        üìñ How to get cookies?
                    </button>
                </div>

                <div class="card">
                    <div class="card-title">üìä Progress</div>
                    <div class="progress-section">
                        <div class="progress-steps">
                            <div class="progress-line" id="progressLine" style="width: 0%; transition: width 0.6s ease;"></div>
                            <div class="step" id="step0">
                                <div class="step-circle">üîç</div>
                                <div class="step-label">Scraping</div>
                            </div>
                            <div class="step" id="step1">
                                <div class="step-circle">‚ú®</div>
                                <div class="step-label">Enriching</div>
                            </div>
                            <div class="step" id="step2">
                                <div class="step-circle">üìÑ</div>
                                <div class="step-label">Generating</div>
                            </div>
                            <div class="step" id="step3">
                                <div class="step-circle">üíæ</div>
                                <div class="step-label">Saving</div>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-label" id="progressLabel">0%</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìù Logs</div>
                    <div class="log-container" id="logContainer"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="startDemo()" id="startBtn">
                        ‚ñ∂Ô∏è Start Export
                    </button>
                    <button class="btn btn-secondary" onclick="openHTML()" id="openHtmlBtn">
                        üåê Open HTML
                    </button>
                    <button class="btn btn-secondary" onclick="openFolder()" id="openFolderBtn">
                        üìÅ Open Folder
                    </button>
                </div>
            `;
        }

        // Other views
        function showHistory() {
            let html = `
                <div class="header">
                    <div class="breadcrumb">
                        <span class="active">History</span>
                    </div>
                </div>
            `;
            if (exportHistory.length === 0) {
                html += `
                    <div class="card" style="text-align: center; padding: 60px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üì≠</div>
                        <h2>No activity yet</h2>
                        <p style="color: #94a3b8; margin-top: 10px;">Start your first export to see history</p>
                        <button class="btn btn-primary" onclick="switchView('export')" style="margin-top: 20px;">
                            Start First Export
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div class="card">
                        <div class="card-title">üïê Export History</div>
                        <table class="history-table" style="width:100%; border-collapse:collapse; margin-top:20px;">
                            <thead>
                                <tr style="background:#f1f5f9; color:#475569;">
                                    <th style="padding:8px; border-bottom:1px solid #e2e8f0;">Date</th>
                                    <th style="padding:8px; border-bottom:1px solid #e2e8f0;">Site</th>
                                    <th style="padding:8px; border-bottom:1px solid #e2e8f0;">Mode</th>
                                    <th style="padding:8px; border-bottom:1px solid #e2e8f0;">Manga Count</th>
                                    <th style="padding:8px; border-bottom:1px solid #e2e8f0;">Output Folder</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                for (let entry of exportHistory.slice().reverse()) {
                    html += `
                        <tr style="border-bottom:1px solid #e2e8f0;">
                            <td style="padding:8px;">${new Date(entry.date).toLocaleString()}</td>
                            <td style="padding:8px;">${entry.site}</td>
                            <td style="padding:8px;">${entry.mode}</td>
                            <td style="padding:8px; text-align:center;">${entry.count}</td>
                            <td style="padding:8px;">${entry.output}</td>
                        </tr>
                    `;
                }
                html += `
                            </tbody>
                        </table>
                        <button class="btn btn-secondary" style="margin-top:20px;" onclick="clearHistory()">üïê Clear Export History</button>
                    </div>
                `;
            }
            document.getElementById('mainContent').innerHTML = html;
        }

        function showSettings() {
            const html = `
                <div class="header">
                    <div class="breadcrumb">
                        <span class="active">Settings</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üé® Appearance</div>
                    <div class="card-subtitle">Customize the look and feel of the application</div>
                    
                    <div class="input-group">
                        <label class="input-label">Theme</label>
                        <div class="custom-select" id="themeSelect">
                            <div class="select-trigger">
                                <span class="select-value">Dark (Default)</span>
                                <span class="select-arrow">‚ñº</span>
                            </div>
                            <div class="select-options">
                                <div class="select-option" data-value="dark">üåô Dark (Default)</div>
                                <div class="select-option" data-value="light">‚òÄÔ∏è Light</div>
                                <div class="select-option" data-value="auto">üîÑ Auto (System)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Animation Speed</label>
                        <div class="custom-select" id="animSpeedSelect">
                            <div class="select-trigger">
                                <span class="select-value">Normal</span>
                                <span class="select-arrow">‚ñº</span>
                            </div>
                            <div class="select-options">
                                <div class="select-option" data-value="slow">üê¢ Slow</div>
                                <div class="select-option" data-value="normal">‚ö° Normal</div>
                                <div class="select-option" data-value="fast">üöÄ Fast</div>
                                <div class="select-option" data-value="none">‚è∏Ô∏è None</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Font Size</label>
                        <div class="custom-select" id="fontSizeSelect">
                            <div class="select-trigger">
                                <span class="select-value">Medium</span>
                                <span class="select-arrow">‚ñº</span>
                            </div>
                            <div class="select-options">
                                <div class="select-option" data-value="small">üîç Small</div>
                                <div class="select-option" data-value="medium">üìù Medium</div>
                                <div class="select-option" data-value="large">üîé Large</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="opacity: 0.5; pointer-events: none; filter: grayscale(1);">
                    <div class="card-title">üîî Notifications</div>
                    <div class="card-subtitle">Manage how you receive notifications (Coming Soon)</div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Desktop Notifications</div>
                            <div style="font-size: 12px; color: #94a3b8;">Show system notifications on export completion</div>
                        </div>
                        <label class="toggle" onclick="toggleSetting('desktopNotifications', 'desktopNotif', event)">
                            <input type="checkbox" id="desktopNotif" ` + (appSettings.desktopNotifications ? 'checked' : '') + `>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Sound Effects</div>
                            <div style="font-size: 12px; color: #94a3b8;">Play sound on export completion</div>
                        </div>
                        <label class="toggle" onclick="toggleSetting('soundEffects', 'soundFx', event)">
                            <input type="checkbox" id="soundFx" ` + (appSettings.soundEffects ? 'checked' : '') + `>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Error Notifications</div>
                            <div style="font-size: 12px; color: #94a3b8;">Alert on export errors</div>
                        </div>
                        <label class="toggle" onclick="toggleSetting('errorNotifications', 'errorNotif', event)">
                            <input type="checkbox" id="errorNotif" ` + (appSettings.errorNotifications ? 'checked' : '') + `>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üì§ Export Settings</div>
                    <div class="card-subtitle">Configure export behavior and defaults</div>
                    
                    <div class="input-group">
                        <label class="input-label">Default Export Format</label>
                        <div class="custom-select" id="exportFormatSelect">
                            <div class="select-trigger">
                                <span class="select-value">MAL XML + HTML</span>
                                <span class="select-arrow">‚ñº</span>
                            </div>
                            <div class="select-options">
                                <div class="select-option" data-value="MAL XML + HTML">üì¶ MAL XML + HTML</div>
                                <div class="select-option" data-value="MAL XML Only">üìÑ MAL XML Only</div>
                                <div class="select-option" data-value="HTML Only">üåê HTML Only</div>
                                <div class="select-option" data-value="JSON">üîß JSON</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Output Directory</label>
                        <input type="text" class="input-field" id="outputDir" value="` + appSettings.outputDirectory + `" onchange="appSettings.outputDirectory = this.value; saveSettings();" />
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Auto-open HTML after export</div>
                            <div style="font-size: 12px; color: #94a3b8;">Automatically open HTML file when export completes</div>
                        </div>
                        <label class="toggle" onclick="toggleSetting('autoOpenHTML', 'autoOpen', event)">
                            <input type="checkbox" id="autoOpen" ` + (appSettings.autoOpenHTML ? 'checked' : '') + `>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Include unmatched manga</div>
                            <div style="font-size: 12px; color: #94a3b8;">Include manga without MAL ID in export</div>
                        </div>
                        <label class="toggle" onclick="toggleSetting('includeUnmatched', 'includeUnmatched', event)">
                            <input type="checkbox" id="includeUnmatched" ` + (appSettings.includeUnmatched ? 'checked' : '') + `>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="card" style="opacity: 0.5; pointer-events: none; filter: grayscale(1);">
                    <div class="card-title">üåê Network</div>
                    <div class="card-subtitle">Configure network and API settings (Coming Soon)</div>
                    <div class="input-group">
                        <label class="input-label">Request Timeout (seconds)</label>
                        <input type="number" class="input-field" id="reqTimeout" value="` + appSettings.requestTimeout + `" min="5" max="120" onchange="appSettings.requestTimeout = parseInt(this.value); saveSettings();" />
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Retries</label>
                        <input type="number" class="input-field" id="maxRetries" value="` + appSettings.maxRetries + `" min="0" max="10" onchange="appSettings.maxRetries = parseInt(this.value); saveSettings();" />
                    </div>
                    <div class="input-group">
                        <label class="input-label">Rate Limit (requests per second)</label>
                        <input type="number" class="input-field" id="rateLimit" value="` + appSettings.rateLimit + `" min="1" max="10" step="0.5" onchange="appSettings.rateLimit = parseFloat(this.value); saveSettings();" />
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Use Proxy</div>
                            <div style="font-size: 12px; color: #94a3b8;">Route requests through proxy server</div>
                        </div>
                        <label class="toggle" onclick="toggleSetting('useProxy', 'useProxy', event)">
                            <input type="checkbox" id="useProxy" ` + (appSettings.useProxy ? 'checked' : '') + `>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üíæ Data & Privacy</div>
                    <div class="card-subtitle">Manage your data and privacy preferences</div>
                    <button class="btn btn-secondary" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
                    <button class="btn btn-secondary" style="margin-left: 10px;" onclick="clearHistory()">üïê Clear Export History</button>
                    <button class="btn btn-secondary" style="margin-left: 10px;" onclick="exportSettings()">üì• Export Settings</button>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px;">
                        <div style="font-weight: 600; color: #ef4444; margin-bottom: 5px;">‚ö†Ô∏è Danger Zone</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 10px;">These actions cannot be undone</div>
                        <button class="btn" style="background: #ef4444; color: white;" onclick="resetAllSettings()">üîÑ Reset All Settings</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px; padding: 20px; color: #94a3b8; font-size: 12px;">
                    <div>Multi-Site Manga Exporter v2.0.0</div>
                    <div style="margin-top: 5px;">Made with ‚ù§Ô∏è by the community</div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            // Add toggle switch styles if not already present
            if (!document.querySelector('style[data-toggle]')) {
                const style = document.createElement('style');
                style.setAttribute('data-toggle', 'true');
                style.textContent = `
                    .toggle {
                        position: relative;
                        display: inline-block;
                        width: 50px;
                        height: 26px;
                        cursor: pointer;
                    }
                    .toggle input {
                        opacity: 0;
                        width: 0;
                        height: 0;
                    }
                    .toggle-slider {
                        position: absolute;
                        cursor: pointer;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: #334155;
                        transition: 0.4s;
                        border-radius: 34px;
                    }
                    .toggle-slider:before {
                        position: absolute;
                        content: "";
                        height: 20px;
                        width: 20px;
                        left: 3px;
                        bottom: 3px;
                        background-color: white;
                        transition: 0.4s;
                        border-radius: 50%;
                    }
                    .toggle input:checked + .toggle-slider {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    }
                   
                    .toggle input:checked + .toggle-slider:before {
                        transform: translateX(24px);
                    }
                    .toggle-active .toggle-slider {
                        box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Initialize custom selects after DOM insertion
            setTimeout(() => {
                initCustomSelect('themeSelect', appSettings.theme, (val) => applyTheme(val, true));
                initCustomSelect('animSpeedSelect', appSettings.animationSpeed, (val) => applyAnimationSpeed(val, true));
                initCustomSelect('fontSizeSelect', appSettings.fontSize, (val) => applyFontSize(val, true));
                initCustomSelect('exportFormatSelect', appSettings.exportFormat, (val) => {
                    appSettings.exportFormat = val;
                    saveSettings(true);
                });
            }, 10);
        }

        function showHelp() {
            document.getElementById('mainContent').innerHTML = `
                <div class="header">
                    <div class="breadcrumb">
                        <span class="active">Help</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">‚ùì Getting Started</div>
                    <div class="card-subtitle">Learn how to use the Multi-Site Manga Exporter</div>
                    <ol style="line-height: 2; color: #94a3b8;">
                        <li>Go to the Export tab</li>
                        <li>Select your source site (currently MangaPark)</li>
                        <li>Choose authentication mode</li>
                        <li>Enter your cookies if using Authenticated mode</li>
                        <li>Click "Start Export"</li>
                    </ol>
                </div>
            `;
        }

        // Demo Export
        function startDemo() {
            isExporting = true;
            progress = 0;
            currentStep = 0;
            
            const startBtn = document.getElementById('startBtn');
            const demoBtn = document.getElementById('demoBtn');
            
            if (startBtn) startBtn.disabled = true;
            if (demoBtn) demoBtn.innerHTML = '<span class="spinner"></span> Running Demo...';

            addLog('üöÄ Starting demo export...', 'info');
            
            // Reset progress
            updateProgress(0);
            resetSteps();

            // Simulate export process
            simulateExport();
        }
        
        function openHTML() {
            console.log('openHTML called, autoOpenHTML setting:', appSettings.autoOpenHTML);
            
            if (window.backendAPI && window.backendAPI.open_html) {
                console.log('Calling backend open_html...');
                window.backendAPI.open_html(function(result) {
                    console.log('Backend response:', result);
                    const data = JSON.parse(result);
                    if (data.status === 'success') {
                        showToast('Opening HTML file...', 'success');
                    } else {
                        showToast(data.message || 'HTML file not found', 'error');
                    }
                });
            } else {
                console.log('Backend API not available or open_html method missing');
                showToast('Feature not available in demo mode', 'warning');
            }
        }
        
        function openFolder() {
            if (window.backendAPI && window.backendAPI.open_folder) {
                window.backendAPI.open_folder(function(result) {
                    const data = JSON.parse(result);
                    if (data.status === 'success') {
                        showToast('Opening output folder...', 'success');
                    } else {
                        showToast(data.message || 'Output folder not found', 'error');
                    }
                });
            } else {
                showToast('Feature not available in demo mode', 'warning');
            }
        }

        function simulateExport() {
            // Step 1: Scraping
            setTimeout(() => {
                updateStep(0, 'active');
                addLog('üîç Scraping manga list from MangaPark...', 'info');
                updateProgress(10);
            }, 500);

            setTimeout(() => {
                addLog('   Found 50 manga in follows list', 'info');
                updateProgress(25);
                updateStep(0, 'done');
                addLog('‚úÖ Scraping completed', 'success');
            }, 2000);

            // Step 2: Enriching
            setTimeout(() => {
                updateStep(1, 'active');
                addLog('‚ú® Enriching with MAL IDs...', 'info');
                updateProgress(35);
            }, 2500);

            for (let i = 1; i <= 10; i++) {
                setTimeout(() => {
                    addLog(`   Matched: Manga ${i} ‚Üí MAL ID: ${1000 + i}`, 'success');
                    updateProgress(35 + (i * 3));
                }, 2500 + (i * 300));
            }

            setTimeout(() => {
                addLog('   ‚úì 10 manga matched with MAL IDs', 'success');
                updateProgress(70);
                updateStep(1, 'done');
                addLog('‚úÖ Enrichment completed', 'success');
            }, 6000);

            // Step 3: Generating
            setTimeout(() => {
                updateStep(2, 'active');
                addLog('üìÑ Generating XML export...', 'info');
                updateProgress(75);
            }, 6500);

            setTimeout(() => {
                addLog('   ‚úì XML structure created', 'info');
                updateProgress(85);
                addLog('üåê Creating HTML visualization...', 'info');
            }, 7500);

            setTimeout(() => {
                addLog('   ‚úì HTML page with search generated', 'info');
                updateProgress(90);
                updateStep(2, 'done');
                addLog('‚úÖ Export files generated', 'success');
            }, 8500);

            // Step 4: Saving
            setTimeout(() => {
                updateStep(3, 'active');
                addLog('üíæ Saving files to output/ folder...', 'info');
                updateProgress(95);
            }, 9000);

            setTimeout(() => {
                addLog('   ‚úì mangapark_to_mal.xml saved', 'success');
            }, 9500);

            setTimeout(() => {
                addLog('   ‚úì manga_list.html saved', 'success');
            }, 9800);

            setTimeout(() => {
                addLog('   ‚úì mal_id_report.txt saved', 'success');
                updateProgress(100);
                updateStep(3, 'done');
                addLog('üéâ Demo export completed successfully!', 'success');
                addLog('üìÅ Files saved to output/ folder', 'success');
                
                // Sauvegarder l'export dans l'historique
                const exportEntry = {
                    date: new Date().toISOString(),
                    site: 'MangaPark',
                    mode: currentMode,
                    count: 10,
                    output: appSettings.outputDirectory
                };
                exportHistory.push(exportEntry);
                localStorage.setItem('exportHistory', JSON.stringify(exportHistory));
                
                const demoBtn = document.getElementById('demoBtn');
                const startBtn = document.getElementById('startBtn');
                if (demoBtn) demoBtn.innerHTML = 'üé¨ Demo Mode';
                if (startBtn) startBtn.disabled = false;
                if (demoBtn) demoBtn.disabled = false;
                
                isExporting = false;
                
                // Trigger notifications (includes auto-open HTML)
                notifyExportComplete(10, 10);
                
                showToast('Export completed successfully! üéâ', 'success');
            }, 10300);
        }

        function updateProgress(percent) {
            progress = percent;
            const bar = document.getElementById('progressBar');
            const label = document.getElementById('progressLabel');
            const line = document.getElementById('progressLine');
            
            if (bar) bar.style.width = percent + '%';
            if (label) label.textContent = Math.round(percent) + '%';
            
            // Sync mini progress line with main progress bar
            if (line) {
                const steps = document.querySelectorAll('.step');
                if (steps.length > 0) {
                    const container = steps[0].parentElement;
                    const containerWidth = container.offsetWidth;
                    const circleWidth = 60;
                    const availableWidth = containerWidth - (circleWidth * 2);
                    const lineWidth = (percent / 100) * availableWidth;
                    line.style.width = lineWidth + 'px';
                }
            }
        }

        function updateStep(stepNum, status) {
            const step = document.getElementById('step' + stepNum);
            if (!step) return;
            
            step.classList.remove('active', 'done');
            if (status === 'active') {
                step.classList.add('active');
                currentStep = stepNum;
            } else if (status === 'done') {
                step.classList.add('done');
                const circle = step.querySelector('.step-circle');
                if (circle) circle.textContent = '‚úÖ';
            }
        }

        function resetSteps() {
            for (let i = 0; i < 4; i++) {
                const step = document.getElementById('step' + i);
                if (step) {
                    step.classList.remove('active', 'done');
                    const icons = ['üîç', '‚ú®', 'üìÑ', 'üíæ'];
                    const circle = step.querySelector('.step-circle');
                    if (circle) circle.textContent = icons[i];
                }
            }
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            if (!container) return;
            
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            // Apply current theme to toast
            if (appSettings.theme === 'light') {
                toast.style.background = '#ffffff';
                toast.style.color = '#1e293b';
                toast.style.boxShadow = '0 10px 40px rgba(0, 0, 0, 0.15)';
                toast.style.border = '1px solid #e2e8f0';
            } else {
                toast.style.background = '#1e293b';
                toast.style.color = '#e2e8f0';
                toast.style.boxShadow = '0 10px 40px rgba(0, 0, 0, 0.3)';
            }
            
            toast.innerHTML = `
                <span style="font-size: 24px;">${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.4s reverse';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function selectSite(site) {
            currentSite = site;
            document.querySelectorAll('.site-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.site-card')?.classList.add('active');
        }

        function selectMode(mode, evt) {
            currentMode = mode;
            console.log('Mode changed to:', mode);
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            evt.target.closest('.mode-card')?.classList.add('active');
            
            // Hide config section if Public mode is selected
            const configSection = document.getElementById('configSection');
            if (configSection) {
                if (mode === 'public') {
                    configSection.style.display = 'none';
                } else {
                    configSection.style.display = 'block';
                }
            }
        }

        function showTutorial() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    background: ${appSettings.theme === 'light' ? '#ffffff' : '#1e293b'};
                    border-radius: 16px;
                    max-width: 700px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, ${appSettings.theme === 'light' ? '0.2' : '0.5'});
                    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                ">
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 30px;
                        border-radius: 16px 16px 0 0;
                    ">
                        <h2 style="margin: 0; font-size: 24px; color: white;">üç™ How to Extract Cookies</h2>
                        <p style="margin: 10px 0 0; opacity: 0.9; color: white;">Follow these steps to get your MangaPark cookies</p>
                    </div>

                    <div style="padding: 30px;">
                        <div style="margin-bottom: 30px;">
                            <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 18px;
                                    flex-shrink: 0;
                                    color: white;
                                ">1</div>
                                <div>
                                    <h3 style="margin: 0 0 10px; font-size: 16px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">Open Developer Tools</h3>
                                    <p style="margin: 0; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; line-height: 1.6;">
                                        Go to <strong>mangapark.net</strong> and press <kbd style="background: ${appSettings.theme === 'light' ? '#e2e8f0' : '#334155'}; padding: 3px 8px; border-radius: 4px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">F12</kbd> 
                                        or right-click ‚Üí <strong>Inspect</strong>
                                    </p>
                                </div>
                            </div>

                            <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 18px;
                                    flex-shrink: 0;
                                    color: white;
                                ">2</div>
                                <div>
                                    <h3 style="margin: 0 0 10px; font-size: 16px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">Navigate to Application Tab</h3>
                                    <p style="margin: 0; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; line-height: 1.6;">
                                        Click on the <strong>Application</strong> tab (Chrome/Edge) or <strong>Storage</strong> tab (Firefox)
                                    </p>
                                </div>
                            </div>

                            <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 18px;
                                    flex-shrink: 0;
                                    color: white;
                                ">3</div>
                                <div>
                                    <h3 style="margin: 0 0 10px; font-size: 16px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">Find Cookies</h3>
                                    <p style="margin: 0; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; line-height: 1.6;">
                                        In the left sidebar, expand <strong>Cookies</strong> ‚Üí click on <strong>https://mangapark.net</strong>
                                    </p>
                                </div>
                            </div>

                            <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 18px;
                                    flex-shrink: 0;
                                    color: white;
                                ">4</div>
                                <div>
                                    <h3 style="margin: 0 0 10px; font-size: 16px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">Copy Required Cookies</h3>
                                    <p style="margin: 0 0 10px; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; line-height: 1.6;">
                                        Find and copy these cookie values:
                                    </p>
                                    <div style="background: ${appSettings.theme === 'light' ? '#f8fafc' : '#0f172a'}; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid ${appSettings.theme === 'light' ? '#e2e8f0' : 'transparent'};">
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: #667eea;">skey</strong>
                                            <div style="font-size: 12px; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; margin-top: 3px;">
                                                Main authentication key for MangaPark
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: #667eea;">tfv</strong>
                                            <div style="font-size: 12px; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; margin-top: 3px;">
                                                Token fingerprint verification cookie
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: #667eea;">theme</strong>
                                            <div style="font-size: 12px; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; margin-top: 3px;">
                                                Theme preference (dark/light)
                                            </div>
                                        </div>
                                        <div>
                                            <strong style="color: #667eea;">wd</strong>
                                            <div style="font-size: 12px; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; margin-top: 3px;">
                                                Window/device identifier
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 20px;">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 18px;
                                    flex-shrink: 0;
                                    color: white;
                                ">5</div>
                                <div>
                                    <h3 style="margin: 0 0 10px; font-size: 16px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">Paste in Configuration</h3>
                                    <p style="margin: 0; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; line-height: 1.6;">
                                        Return to the Export tab and paste the cookie values in the Configuration section
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div style="
                            background: rgba(245, 158, 11, 0.1);
                            border: 1px solid #f59e0b;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        ">
                            <div style="display: flex; gap: 10px;">
                                <span style="font-size: 20px;">‚ö†Ô∏è</span>
                                <div>
                                    <strong style="color: #f59e0b;">Important Notes:</strong>
                                    <ul style="margin: 10px 0 0 0; padding-left: 20px; color: ${appSettings.theme === 'light' ? '#64748b' : '#94a3b8'}; line-height: 1.8;">
                                        <li>Cookies expire after some time - you may need to refresh them</li>
                                        <li>Make sure you're logged in to MangaPark before extracting cookies</li>
                                        <li>Never share your cookies - they provide access to your account</li>
                                        <li>All 4 cookies (<code style="background: ${appSettings.theme === 'light' ? '#e2e8f0' : '#334155'}; padding: 2px 6px; border-radius: 4px; color: ${appSettings.theme === 'light' ? '#1e293b' : '#e2e8f0'};">skey, tfv, theme, wd</code>) are required</li>
                                        <li>Copy the exact value from the "Value" column in DevTools</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="this.closest('[style*=fixed]').remove()">
                                Close
                            </button>
                            <button class="btn btn-primary" onclick="this.closest('[style*=fixed]').remove(); switchView('export')">
                                Got it! üëç
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Add animation styles
            if (!document.querySelector('style[data-modal]')) {
                const style = document.createElement('style');
                style.setAttribute('data-modal', 'true');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from {
                            opacity: 0;
                            transform: translateY(50px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    kbd {
                        background: #334155;
                        padding: 3px 8px;
                        border-radius: 4px;
                        font-family: monospace;
                        font-size: 13px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ============================================
        // NOTIFICATIONS IMPLEMENTATION
        // ============================================
        
        function requestNotificationPermission() {
            console.log('requestNotificationPermission called, Notification support:', 'Notification' in window);
            console.log('Current permission:', window.Notification ? Notification.permission : 'N/A');
            
            if ('Notification' in window && Notification.permission === 'default') {
                console.log('Requesting notification permission...');
                Notification.requestPermission().then(permission => {
                    console.log('Permission granted:', permission);
                    if (permission === 'granted') {
                        showToast('Desktop notifications enabled', 'success');
                    }
                });
            } else if ('Notification' in window) {
                console.log('Permission already decided:', Notification.permission);
            }
        }

        function showDesktopNotification(title, body, icon = 'üìä') {
            console.log('showDesktopNotification called', { title, body, enabled: appSettings.desktopNotifications });
            
            if (!appSettings.desktopNotifications) {
                console.log('Desktop notifications disabled in settings');
                return;
            }
            
            console.log('Notification permission:', Notification.permission);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                console.log('Creating notification...');
                const notification = new Notification(title, {
                    body: body,
                    icon: icon,
                    badge: icon,
                    tag: 'manga-exporter',
                    requireInteraction: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                setTimeout(() => notification.close(), 5000);
                console.log('Notification created successfully');
            } else if ('Notification' in window && Notification.permission === 'default') {
                console.log('Requesting notification permission...');
                // Ask for permission
                Notification.requestPermission().then(permission => {
                    console.log('Permission result:', permission);
                    if (permission === 'granted') {
                        showDesktopNotification(title, body, icon);
                    }
                });
            } else {
                console.log('Notifications not available or denied');
            }
        }

        function playSuccessSound() {
            console.log('playSuccessSound called, soundEffects enabled:', appSettings.soundEffects);
            if (!appSettings.soundEffects) return;
            
            try {
                console.log('Creating audio context...');
                // Create audio context and play success sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            // Second tone
            setTimeout(() => {
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1000;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.5);
            }, 100);
                
                console.log('Success sound played');
            } catch (error) {
                console.error('Error playing success sound:', error);
            }
        }

        function playErrorSound() {
            console.log('playErrorSound called, soundEffects enabled:', appSettings.soundEffects);
            if (!appSettings.soundEffects) return;
            
            try {
                console.log('Creating audio context for error sound...');
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 200;
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
                
                console.log('Error sound played');
            } catch (error) {
                console.error('Error playing error sound:', error);
            }
        }

        function notifyExportComplete(mangaCount, foundCount) {
            console.log('notifyExportComplete called', { mangaCount, foundCount });
            console.log('Settings:', appSettings);
            
            // Play sound
            if (appSettings.soundEffects) {
                console.log('Playing success sound');
                playSuccessSound();
            }
            
            // Show desktop notification
            if (appSettings.desktopNotifications) {
                console.log('Showing desktop notification');
                showDesktopNotification(
                    'üéâ Export Completed!',
                    `Successfully exported ${mangaCount} manga. ${foundCount} matched with MAL IDs.`,
                    '‚úÖ'
                );
            }
            
            // Auto-open HTML if enabled
            if (appSettings.autoOpenHTML) {
                console.log('Auto-open HTML enabled, attempting to open...');
                setTimeout(() => {
                    openHTML();
                }, 1500);
            }
        }

        function notifyExportError(errorMessage) {
            // Play error sound
            if (appSettings.errorNotifications) {
                playErrorSound();
                
                // Show desktop notification
                showDesktopNotification(
                    '‚ùå Export Failed',
                    errorMessage,
                    '‚ö†Ô∏è'
                );
            }
        }

        // ============================================
        // EXPORT FORMAT IMPLEMENTATION
        // ============================================
        
        function getExportConfig() {
            const config = {
                format: appSettings.exportFormat,
                outputDir: appSettings.outputDirectory,
                includeUnmatched: appSettings.includeUnmatched,
                autoOpen: appSettings.autoOpenHTML
            };
            return config;
        }

        function shouldExportXML() {
            return appSettings.exportFormat === 'MAL XML + HTML' || 
                   appSettings.exportFormat === 'MAL XML Only';
        }

        function shouldExportHTML() {
            return appSettings.exportFormat === 'MAL XML + HTML' || 
                   appSettings.exportFormat === 'HTML Only';
        }

        function shouldExportJSON() {
            return appSettings.exportFormat === 'JSON';
        }

        // ============================================
        // NETWORK SETTINGS IMPLEMENTATION
        // ============================================
        
        let requestQueue = [];
        let lastRequestTime = 0;
        let requestCount = 0;
        let retryAttempts = new Map();

        function getRateLimitDelay() {
            // Convert requests per second to milliseconds delay
            return 1000 / appSettings.rateLimit;
        }

        async function makeRateLimitedRequest(url, options = {}) {
            const now = Date.now();
            const delay = getRateLimitDelay();
            const timeSinceLastRequest = now - lastRequestTime;
            
            // Wait if necessary to respect rate limit
            if (timeSinceLastRequest < delay) {
                await new Promise(resolve => setTimeout(resolve, delay - timeSinceLastRequest));
            }
            
            lastRequestTime = Date.now();
            
            // Set timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), appSettings.requestTimeout * 1000);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                requestCount++;
                
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                
                // Handle retry logic
                const retries = retryAttempts.get(url) || 0;
                
                if (retries < appSettings.maxRetries) {
                    retryAttempts.set(url, retries + 1);
                    addLog(`‚ö†Ô∏è Request failed, retrying... (${retries + 1}/${appSettings.maxRetries})`, 'warning');
                    
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, retries)));
                    
                    return makeRateLimitedRequest(url, options);
                } else {
                    retryAttempts.delete(url);
                    throw error;
                }
            }
        }

        function resetNetworkStats() {
            requestCount = 0;
            retryAttempts.clear();
        }

        function getNetworkStats() {
            return {
                totalRequests: requestCount,
                rateLimit: appSettings.rateLimit,
                timeout: appSettings.requestTimeout,
                maxRetries: appSettings.maxRetries,
                activeRetries: retryAttempts.size
            };
        }

        // ============================================
        // IMPORT SETTINGS IMPLEMENTATION
        // ============================================
        
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        
                        // Validate imported settings
                        if (typeof imported === 'object' && imported !== null) {
                            // Merge with current settings (keep structure)
                            Object.keys(imported).forEach(key => {
                                if (key in appSettings) {
                                    appSettings[key] = imported[key];
                                }
                            });
                            
                            saveSettings();
                            showToast('Settings imported successfully', 'success');
                            
                            // Apply imported theme
                            applyTheme(appSettings.theme, false);
                            applyFontSize(appSettings.fontSize, false);
                            applyAnimationSpeed(appSettings.animationSpeed, false);
                            
                            // Refresh settings view if currently on settings page
                            if (currentView === 'settings') {
                                setTimeout(() => showSettings(), 500);
                            }
                        } else {
                            showToast('Invalid settings file format', 'error');
                        }
                    } catch (error) {
                        showToast('Error reading settings file: ' + error.message, 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ============================================
        // ENHANCED EXPORT WITH SETTINGS
        // ============================================
        
        // Override simulateExport to use settings
        const originalSimulateExport = simulateExport;
        simulateExport = function() {
            resetNetworkStats();
            
            // Call original export
            originalSimulateExport();
            
            // Patch the completion to use notifications
            setTimeout(() => {
                notifyExportComplete(10, 10);
            }, 10500);
        };

        // ============================================
        // INITIALIZE NOTIFICATION PERMISSION
        // ============================================
        
        // Request notification permission on first load
        setTimeout(() => {
            if (appSettings.desktopNotifications && 'Notification' in window && Notification.permission === 'default') {
                requestNotificationPermission();
            }
        }, 2000);

        // Add import settings button to settings page (will be added via DOM manipulation)
        function enhanceSettingsPage() {
            const exportBtn = document.querySelector('button[onclick="exportSettings()"]');
            if (exportBtn && !document.getElementById('importSettingsBtn')) {
                const importBtn = document.createElement('button');
                importBtn.id = 'importSettingsBtn';
                importBtn.className = 'btn btn-secondary';
                importBtn.style.marginLeft = '10px';
                importBtn.innerHTML = 'üì§ Import Settings';
                importBtn.onclick = importSettings;
                exportBtn.parentNode.insertBefore(importBtn, exportBtn.nextSibling);
            }
        }

        // Watch for settings view to add import button
        const originalShowSettings = showSettings;
        showSettings = function() {
            originalShowSettings();
            setTimeout(enhanceSettingsPage, 50);
        };

    </script>
</body>
</html>
